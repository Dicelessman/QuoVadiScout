rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // COLLEZIONE: strutture
    // Accesso completamente privato - solo utenti autenticati
    // ============================================
    match /strutture/{structureId} {
      // Lettura: Solo utenti autenticati con email verificata
      allow read: if request.auth != null && 
                     request.auth.token.email_verified == true;

      // Scrittura: Solo utenti autenticati con email verificata
      allow write: if request.auth != null && 
                      request.auth.token.email_verified == true;
      
      // Documento specifico
      allow get: if request.auth != null && 
                    request.auth.token.email_verified == true;
      allow list: if request.auth != null && 
                     request.auth.token.email_verified == true;
    }

    // ============================================
    // COLLEZIONE: users
    // Solo il proprio profilo
    // ============================================
    match /users/{userId} {
      // Lettura: Solo il proprio profilo con email verificata
      allow read: if request.auth != null && 
                     request.auth.uid == userId &&
                     request.auth.token.email_verified == true;

      // Scrittura: Solo il proprio profilo con email verificata
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.auth.token.email_verified == true;
    }

    // ============================================
    // COLLEZIONE: userLists (elenchi personali)
    // Solo il proprietario
    // ============================================
    match /userLists/{listId} {
      // Lettura: Solo il proprietario con email verificata
      allow read: if request.auth != null &&
                    request.auth.token.email_verified == true &&
                    resource.data.userId == request.auth.uid;

      // Scrittura: Solo il proprietario con email verificata
      allow write: if request.auth != null &&
                     request.auth.token.email_verified == true &&
                     request.resource.data.userId == request.auth.uid;
    }

    // ============================================
    // COLLEZIONE: activityLog e activity_log (log attività)
    // Solo utenti autenticati possono leggere i propri log
    // ============================================
    match /activityLog/{logId} {
      // Solo utenti autenticati con email verificata possono leggere i propri log
      allow read: if request.auth != null &&
                    request.auth.token.email_verified == true &&
                    resource.data.userId == request.auth.uid;

      // Solo utenti autenticati con email verificata possono creare log
      allow create: if request.auth != null &&
                      request.auth.token.email_verified == true &&
                      request.resource.data.userId == request.auth.uid;

      // Nessuno può modificare o eliminare i log
      allow update, delete: if false;
    }

    match /activity_log/{logId} {
      // Lettura: Solo utenti autenticati con email verificata
      allow read: if request.auth != null && 
                     request.auth.token.email_verified == true;

      // Solo utenti autenticati con email verificata possono creare log
      allow create: if request.auth != null && 
                      request.auth.token.email_verified == true;

      // Nessuno può modificare o eliminare i log
      allow update, delete: if false;
    }

    // ============================================
    // COLLEZIONE: structureVersions (versioni strutture)
    // Solo utenti autenticati possono leggere
    // ============================================
    match /structureVersions/{versionId} {
      // Solo utenti autenticati con email verificata possono leggere
      allow read: if request.auth != null &&
                    request.auth.token.email_verified == true;

      // Solo utenti autenticati con email verificata possono creare versioni
      allow create: if request.auth != null &&
                      request.auth.token.email_verified == true;

      // Nessuno può modificare o eliminare versioni
      allow update, delete: if false;
    }

    // ============================================
    // COLLEZIONE: structure_reports (segnalazioni)
    // Solo utenti autenticati possono creare
    // ============================================
    match /structure_reports/{reportId} {
      // Solo utenti autenticati con email verificata possono leggere
      allow read: if request.auth != null &&
                    request.auth.token.email_verified == true;

      // Solo utenti autenticati con email verificata possono creare segnalazioni
      allow create: if request.auth != null &&
                      request.auth.token.email_verified == true;

      // Solo il creatore può aggiornare la propria segnalazione
      allow update: if request.auth != null &&
                      request.auth.token.email_verified == true &&
                      resource.data.userId == request.auth.uid;

      // Nessuno può eliminare segnalazioni
      allow delete: if false;
    }

    // ============================================
    // COLLEZIONE: user_notification_prefs (preferenze notifiche)
    // Solo il proprietario
    // ============================================
    match /user_notification_prefs/{userId} {
      // Solo il proprietario con email verificata può leggere/scrivere
      allow read, write: if request.auth != null &&
                           request.auth.token.email_verified == true &&
                           request.auth.uid == userId;
    }

    // ============================================
    // COLLEZIONE: user_filters (filtri salvati)
    // Solo il proprietario
    // ============================================
    match /user_filters/{filterId} {
      // Solo il proprietario con email verificata può leggere/scrivere
      allow read, write: if request.auth != null &&
                           request.auth.token.email_verified == true &&
                           resource.data.userId == request.auth.uid;
      
      // Per i nuovi documenti, controlla che userId sia corretto
      allow create: if request.auth != null &&
                      request.auth.token.email_verified == true &&
                      request.resource.data.userId == request.auth.uid;
    }

    // ============================================
    // BLOCCO DEFAULT: Tutto il resto negato
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

