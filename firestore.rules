rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // COLLEZIONE: strutture
    // Lettura pubblica, scrittura solo autenticati
    // ============================================
    match /strutture/{structureId} {
      // Lettura: Accesso pubblico per visualizzazione
      allow read: if true;

      // Scrittura: Solo utenti autenticati
      allow write: if request.auth != null;
      
      // Documento specifico
      allow get: if true;
      allow list: if true;
    }

    // ============================================
    // COLLEZIONE: users
    // Solo il proprio profilo
    // ============================================
    match /users/{userId} {
      // Lettura: Solo il proprio profilo
      allow read: if request.auth != null && request.auth.uid == userId;

      // Scrittura: Solo il proprio profilo
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ============================================
    // COLLEZIONE: userLists (elenchi personali)
    // Solo il proprietario
    // ============================================
    match /userLists/{listId} {
      // Lettura: Solo il proprietario
      allow read: if request.auth != null &&
                    resource.data.userId == request.auth.uid;

      // Scrittura: Solo il proprietario
      allow write: if request.auth != null &&
                     request.resource.data.userId == request.auth.uid;
    }

    // ============================================
    // COLLEZIONE: activityLog e activity_log (log attività)
    // Solo utenti autenticati possono leggere i propri log
    // ============================================
    match /activityLog/{logId} {
      // Solo utenti autenticati possono leggere i propri log
      allow read: if request.auth != null &&
                    resource.data.userId == request.auth.uid;

      // Solo utenti autenticati possono creare log
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;

      // Nessuno può modificare o eliminare i log
      allow update, delete: if false;
    }

    match /activity_log/{logId} {
      // Lettura: Accesso pubblico per visualizzazione feed
      allow read: if true;

      // Solo utenti autenticati possono creare log
      allow create: if request.auth != null;

      // Nessuno può modificare o eliminare i log
      allow update, delete: if false;
    }

    // ============================================
    // COLLEZIONE: structureVersions (versioni strutture)
    // Solo utenti autenticati possono leggere
    // ============================================
    match /structureVersions/{versionId} {
      // Solo utenti autenticati possono leggere
      allow read: if request.auth != null;

      // Solo utenti autenticati possono creare versioni
      allow create: if request.auth != null;

      // Nessuno può modificare o eliminare versioni
      allow update, delete: if false;
    }

    // ============================================
    // COLLEZIONE: structure_reports (segnalazioni)
    // Solo utenti autenticati possono creare
    // ============================================
    match /structure_reports/{reportId} {
      // Solo utenti autenticati possono leggere
      allow read: if request.auth != null;

      // Solo utenti autenticati possono creare segnalazioni
      allow create: if request.auth != null;

      // Solo il creatore può aggiornare la propria segnalazione
      allow update: if request.auth != null &&
                      resource.data.userId == request.auth.uid;

      // Nessuno può eliminare segnalazioni
      allow delete: if false;
    }

    // ============================================
    // COLLEZIONE: user_notification_prefs (preferenze notifiche)
    // Solo il proprietario
    // ============================================
    match /user_notification_prefs/{userId} {
      // Solo il proprietario può leggere/scrivere
      allow read, write: if request.auth != null &&
                           request.auth.uid == userId;
    }

    // ============================================
    // COLLEZIONE: user_filters (filtri salvati)
    // Solo il proprietario
    // ============================================
    match /user_filters/{filterId} {
      // Solo il proprietario può leggere/scrivere
      allow read, write: if request.auth != null &&
                           resource.data.userId == request.auth.uid;
      
      // Per i nuovi documenti, controlla che userId sia corretto
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;
    }
    
    // Permetti query sulla collezione user_filters per utenti autenticati
    match /user_filters/{document=**} {
      allow read: if request.auth != null;
    }

    // ============================================
    // BLOCCO DEFAULT: Tutto il resto negato
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

