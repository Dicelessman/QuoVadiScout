rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // COLLEZIONE: strutture
    // Lettura pubblica, scrittura solo autenticati
    // ============================================
    match /strutture/{structureId} {
      // Lettura: Accesso pubblico per visualizzazione
      allow read: if true;

      // Scrittura: Solo utenti autenticati
      allow write: if request.auth != null;
      
      // Documento specifico
      allow get: if true;
      allow list: if true;
    }

    // ============================================
    // COLLEZIONE: users
    // Solo il proprio profilo con validazioni rigorose
    // ============================================
    match /users/{userId} {
      // Lettura: Solo il proprio profilo
      allow read: if request.auth != null && 
                    request.auth.uid == userId &&
                    request.auth.token.email_verified == true;

      // Scrittura: Solo il proprio profilo con validazioni
      allow write: if request.auth != null && 
                     request.auth.uid == userId &&
                     request.auth.token.email_verified == true &&
                     // Verifica che i dati siano coerenti
                     (request.resource.data.email == request.auth.token.email);
    }

    // ============================================
    // COLLEZIONE: userLists (elenchi personali)
    // Solo il proprietario con validazioni rigorose
    // ============================================
    match /userLists/{listId} {
      // Lettura: Solo il proprietario
      allow read: if request.auth != null &&
                    request.auth.token.email_verified == true &&
                    resource.data.userId == request.auth.uid;

      // Scrittura: Solo il proprietario
      allow write: if request.auth != null &&
                     request.auth.token.email_verified == true &&
                     request.resource.data.userId == request.auth.uid;
    }

    // ============================================
    // COLLEZIONE: activityLog e activity_log (log attività)
    // Solo utenti autenticati possono leggere i propri log
    // ============================================
    match /activityLog/{logId} {
      // Solo utenti autenticati possono leggere i propri log
      allow read: if request.auth != null &&
                    resource.data.userId == request.auth.uid;

      // Solo utenti autenticati possono creare log
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;

      // Nessuno può modificare o eliminare i log
      allow update, delete: if false;
    }

    match /activity_log/{logId} {
      // Lettura: Accesso pubblico per visualizzazione feed
      allow read: if true;

      // Solo utenti autenticati possono creare log
      allow create: if request.auth != null;

      // Nessuno può modificare o eliminare i log
      allow update, delete: if false;
    }

    // ============================================
    // COLLEZIONE: structure_versions (versioni strutture)
    // Solo utenti autenticati possono leggere
    // ============================================
    match /structure_versions/{versionId} {
      // Solo utenti autenticati possono leggere
      allow read: if request.auth != null;

      // Solo utenti autenticati possono creare versioni
      allow create: if request.auth != null;

      // Nessuno può modificare o eliminare versioni
      allow update, delete: if false;
    }

    // ============================================
    // COLLEZIONE: structure_reports (segnalazioni)
    // Solo utenti autenticati possono creare
    // ============================================
    match /structure_reports/{reportId} {
      // Solo utenti autenticati possono leggere
      allow read: if request.auth != null;

      // Solo utenti autenticati possono creare segnalazioni
      allow create: if request.auth != null;

      // Solo il creatore può aggiornare la propria segnalazione
      allow update: if request.auth != null &&
                      resource.data.userId == request.auth.uid;

      // Nessuno può eliminare segnalazioni
      allow delete: if false;
    }

    // ============================================
    // COLLEZIONE: user_notification_prefs (preferenze notifiche)
    // Solo il proprietario
    // ============================================
    match /user_notification_prefs/{userId} {
      // Solo il proprietario può leggere/scrivere
      allow read, write: if request.auth != null &&
                           request.auth.uid == userId;
    }

    // ============================================
    // COLLEZIONE: user_filters (filtri salvati)
    // Solo il proprietario
    // ============================================
    match /user_filters/{filterId} {
      // Solo il proprietario può leggere/scrivere
      allow read, write: if request.auth != null &&
                           resource.data.userId == request.auth.uid;
      
      // Per i nuovi documenti, controlla che userId sia corretto
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;
    }
    
    // Permetti query sulla collezione user_filters per utenti autenticati
    match /user_filters/{document=**} {
      allow read: if request.auth != null;
    }

    // ============================================
    // COLLEZIONE: user_notes (note personali)
    // Solo il proprietario
    // ============================================
    match /user_notes/{noteId} {
      // Lettura: solo il proprietario
      allow read: if request.auth != null &&
                   resource.data.userId == request.auth.uid;
      
      // Creazione: solo il proprietario con userId corretto
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;
      
      // Aggiornamento: solo il proprietario
      allow update: if request.auth != null &&
                      resource.data.userId == request.auth.uid;
      
      // Eliminazione: solo il proprietario
      allow delete: if request.auth != null &&
                      resource.data.userId == request.auth.uid;
    }

    // ============================================
    // COLLEZIONE: structure_ratings (voti strutture)
    // Solo utenti autenticati
    // ============================================
    match /structure_ratings/{ratingId} {
      // Lettura: tutti gli utenti autenticati
      allow read: if request.auth != null;
      
      // Creazione: solo utenti autenticati con userId corretto
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.rating >= 1 &&
                      request.resource.data.rating <= 5;
      
      // Aggiornamento: solo il proprietario del voto
      allow update: if request.auth != null &&
                      resource.data.userId == request.auth.uid;
      
      // Eliminazione: solo il proprietario del voto
      allow delete: if request.auth != null &&
                      resource.data.userId == request.auth.uid;
    }

    // ============================================
    // BLOCCO DEFAULT: Tutto il resto negato
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

