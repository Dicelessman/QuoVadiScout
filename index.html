<!doctype html>
<html lang="it" class="no-js">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
<title>Quovadiscout - Strutture & Terreni</title>
<script>
  // Rimuovi classe no-js se JavaScript √® abilitato
  document.documentElement.classList.remove('no-js');
  document.documentElement.classList.add('js');
</script>
<meta name="description" content="Sistema avanzato per la gestione di strutture e terreni scout" />
<meta name="theme-color" content="#2f6b2f" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="QuoVadiScout" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèïÔ∏è</text></svg>">
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="geolocation-styles.css">
<!-- Font Awesome per icone personalizzate -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Export libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Maps libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
</head>
<body>
  <!-- Fallback no-JavaScript -->
  <noscript>
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 99999; padding: 2rem;">
      <div style="text-align: center; max-width: 500px;">
        <h1 style="color: #2f6b2f; margin-bottom: 1rem;">üèïÔ∏è QuoVadiScout</h1>
        <h2 style="color: #333; margin-bottom: 1rem;">JavaScript √® richiesto</h2>
        <p style="color: #666; margin-bottom: 1.5rem;">Questa applicazione richiede JavaScript per funzionare correttamente. Per favore abilita JavaScript nel tuo browser.</p>
        <p style="color: #999; font-size: 0.9rem;">Abilita JavaScript e ricarica la pagina.</p>
      </div>
    </div>
  </noscript>
  
  <!-- Skip Navigation Link per Accessibilit√† -->
  <a href="#main-content" class="sr-only skip-link">Salta al contenuto principale</a>
  
  <!-- Mobile-First Header -->
  <header class="app-header">
    <div class="header-main">
      <div class="header-brand">
        <h1 class="app-title">üèïÔ∏è QuoVadiScout </h1>
      </div>
      <div class="header-actions">
        <button id="menuToggle" class="btn-menu" aria-label="Menu principale">
          <span class="hamburger"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- Search Bar -->
  <div class="search-section" role="search">
    <div class="search-container">
      <input id="search" class="search-input" placeholder="Cerca strutture..." />
    </div>
  </div>

  <!-- Main Navigation Menu -->
  <nav id="mainMenu" class="main-menu hidden" role="navigation" aria-label="Menu principale">
    <div class="menu-sections">
      <!-- Search & Filters -->
      <section class="menu-section">
        <h3 class="menu-section-title">üîç Ricerca & Filtri</h3>
        <div class="menu-items">
          <button class="menu-item" onclick="mostraRicercaAvanzata()">
            <span class="menu-icon"><i class="fas fa-search"></i></span>
            <span class="menu-label">Ricerca Avanzata</span>
          </button>
          <button class="menu-item" onclick="mostraMappa()">
            <span class="menu-icon"><i class="fas fa-map-marked-alt"></i></span>
            <span class="menu-label">Visualizza Mappa</span>
          </button>
          <button class="menu-item" id="sortMenuBtn">
            <span class="menu-icon"><i class="fas fa-sort-amount-down"></i></span>
            <span class="menu-label">Ordina per</span>
            <select id="sort-by" class="menu-select">
              <option value="struttura">Nome</option>
              <option value="luogo">Luogo</option>
              <option value="provincia">Provincia</option>
            </select>
          </button>
          <button class="menu-item" id="savedFiltersBtn">
            <span class="menu-icon"><i class="fas fa-bookmark"></i></span>
            <span class="menu-label">Filtri Salvati</span>
            <select id="saved-filters" class="menu-select">
              <option value="">Seleziona filtro...</option>
            </select>
          </button>
        </div>
      </section>

      <!-- Personal Lists -->
      <section class="menu-section">
        <h3 class="menu-section-title">üìã Le Mie Liste</h3>
        <div class="menu-items">
          <button id="exportBtn" class="menu-item">
            <span class="menu-icon"><i class="fas fa-list"></i></span>
            <span class="menu-label">Elenco Personale</span>
            <span id="contatore-elenco" class="menu-badge">0</span>
          </button>
        </div>
      </section>



      <!-- Actions -->
      <section class="menu-section">
        <h3 class="menu-section-title">‚ö° Azioni Rapide</h3>
        <div class="menu-items">
          <button id="add-btn" class="menu-item menu-item-accent">
            <span class="menu-icon"><i class="fas fa-plus"></i></span>
            <span class="menu-label">Aggiungi Struttura</span>
          </button>
          <button id="resetBtn" class="menu-item">
            <span class="menu-icon"><i class="fas fa-undo"></i></span>
            <span class="menu-label">Reset Filtri</span>
          </button>
          <div class="view-toggle menu-item">
            <span class="menu-icon"><i class="fas fa-eye"></i></span>
            <span class="menu-label">Visualizzazione</span>
            <button id="viewToggle" class="view-switch">
              <span class="view-icon"><i class="fas fa-list"></i></span>
              <span class="view-label">Elenco</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Data Management -->
      <section class="menu-section">
        <h3 class="menu-section-title">üìä Gestione Dati</h3>
        <div class="menu-items">
          <button class="menu-item" onclick="mostraModaleSincronizzazione()">
            <span class="menu-icon"><i class="fas fa-sync-alt"></i></span>
            <span class="menu-label">Sincronizza con Firestore</span>
          </button>
          <button class="menu-item" onclick="mostraOpzioniEsportazioneGenerale()">
            <span class="menu-icon"><i class="fas fa-download"></i></span>
            <span class="menu-label">Esporta Dati</span>
          </button>
          <button class="menu-item" onclick="mostraFeedAttivita()">
            <span class="menu-icon"><i class="fas fa-history"></i></span>
            <span class="menu-label">Feed Attivit√†</span>
          </button>
          <button class="menu-item" onclick="location.href='dashboard.html'">
            <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
            <span class="menu-label">Dashboard</span>
          </button>
        </div>
      </section>

      <!-- User & Settings -->
      <section class="menu-section">
        <h3 class="menu-section-title">‚öôÔ∏è Impostazioni</h3>
        <div class="menu-items">
          <button id="themeToggle" class="menu-item">
            <span class="menu-icon"><i class="fas fa-moon"></i></span>
            <span class="menu-label">Cambia Tema</span>
          </button>
          <button id="userBtn" class="menu-item">
            <span class="menu-icon"><i class="fas fa-user"></i></span>
            <span class="menu-label">Utente</span>
          </button>
           <button class="menu-item" onclick="mostraPreferenzeNotifiche()">
             <span class="menu-icon"><i class="fas fa-bell"></i></span>
             <span class="menu-label">Preferenze Notifiche</span>
           </button>
        </div>
      </section>

      <!-- Help & Support -->
      <section class="menu-section">
        <h3 class="menu-section-title">üÜò Aiuto & Supporto</h3>
        <div class="menu-items">
          <button class="menu-item" onclick="mostraAiuto()">
            <span class="menu-icon"><i class="fas fa-question-circle"></i></span>
            <span class="menu-label">Guida Rapida</span>
          </button>
          <button class="menu-item" onclick="mostraAbout()">
            <span class="menu-icon"><i class="fas fa-info-circle"></i></span>
            <span class="menu-label">Informazioni App</span>
          </button>
        </div>
      </section>
    </div>
  </nav>

  <!-- Main Content -->
  <main id="main-content" class="main-content" role="main">
    <!-- Results Counter -->
    <div class="results-header">
      <div class="results-info">
        <span id="resultsCount" class="results-count">0 strutture</span>
        <span id="resultsStatus" class="results-status"></span>
      </div>
    </div>
    
    <!-- Results Grid -->
    <section id="results" class="results-container">
      <!-- Cards will be dynamically inserted here -->
    </section>
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-indicator hidden">
      <div class="loading-spinner"></div>
      <span class="loading-text">Caricamento...</span>
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state hidden">
      <div class="empty-icon"><i class="fas fa-search"></i></div>
      <h3 class="empty-title">Nessuna struttura trovata</h3>
      <p class="empty-description">Prova a modificare i filtri o aggiungi una nuova struttura</p>
      <button id="addBtnEmpty" class="btn-primary"><i class="fas fa-plus"></i> Aggiungi Struttura</button>
    </div>
  </main>

  <!-- Modale di modifica -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <button id="closeModal" class="close"><i class="fas fa-times"></i></button>
      <h2>Modifica struttura</h2>
      <form id="editForm"></form>
      <div class="modal-actions">
        <button id="saveBtn"><i class="fas fa-save"></i> Salva</button>
        <button id="deleteBtn" class="danger"><i class="fas fa-trash"></i> Elimina</button>
        <button id="cancelBtn"><i class="fas fa-times"></i> Annulla</button>
      </div>
    </div>
  </div>

  <script src="maps.js"></script>
  <script src="export.js"></script>
  <script src="push-notifications.js"></script>
  <script src="offline-sync.js"></script>
  <script src="media-manager.js"></script>
  <script src="virtual-scroll.js"></script>
  <script src="integrations.js"></script>
  <script src="gestures.js"></script>
  <script src="smart-notifications.js"></script>
  <script src="analytics.js"></script>
  <script src="backup-sync.js"></script>
  <script src="config.js"></script>
  <script src="test-systems.js"></script>
  <script src="toast-notifications.js"></script>
  <!-- Virtual Scrolling ottimizzato per performance -->
  <script src="virtual-scroll.js"></script>
  <!-- Geolocalizzazione -->
  <script src="geolocation-config.js"></script>
  <script src="geolocation.js"></script>
  <script src="geolocation-ui.js"></script>
  <script src="geolocation-integration.js"></script>
  <!-- Configurazione icone personalizzate -->
  <script src="icons-config.js"></script>
  <!-- Gestione errori -->
  <script src="error-handler.js"></script>
  <script type="module" src="script.js"></script>

<script>
// Registrazione Service Worker per PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      // Prova a registrare il service worker
      const registration = await navigator.serviceWorker.register('./service-worker.js');
      console.log('‚úÖ Service Worker registrato:', registration.scope);
      
      // Gestione aggiornamenti automatici
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // Nuovo service worker disponibile
            showUpdateNotification();
          }
        });
      });
      
      // Listener per messaggi dal service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data.action === 'SW_UPDATED') {
          console.log('üîÑ Service Worker aggiornato');
        }
      });
      
      // Controlla aggiornamenti ogni 30 minuti
      setInterval(() => {
        registration.update();
      }, 30 * 60 * 1000);
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Service Worker non disponibile (modalit√† sviluppo):', error.message);
      // In modalit√† sviluppo, continua senza service worker
      console.log('üì± App funzionante senza PWA features');
    }
  });
}

// Mostra notifica di aggiornamento
function showUpdateNotification() {
  // Rimuovi notifica esistente se presente
  const existingNotification = document.getElementById('updateNotification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  const notification = document.createElement('div');
  notification.id = 'updateNotification';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #2f6b2f;
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 350px;
    animation: slideInRight 0.3s ease-out;
  `;
  
  notification.innerHTML = `
    <div style="flex: 1;">
      <div style="font-weight: 500; margin-bottom: 4px;">üîÑ Nuova versione disponibile!</div>
      <div style="font-size: 14px; opacity: 0.9;">Ricarica la pagina per aggiornare l'app</div>
    </div>
    <button onclick="location.reload()" style="
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    ">Aggiorna ora</button>
    <button onclick="this.closest('#updateNotification').remove()" style="
      background: none;
      color: white;
      border: none;
      padding: 4px;
      cursor: pointer;
      font-size: 18px;
      opacity: 0.7;
    ">√ó</button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-rimuovi dopo 10 secondi
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 10000);
}

// Gestione installazione PWA
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Mostra pulsante installazione personalizzato
  const installBtn = document.createElement('button');
  installBtn.textContent = 'üì± Installa App';
  installBtn.className = 'btn-install';
  installBtn.style.cssText = `
    background: #2f6b2f;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 8px;
  `;
  
  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Risultato installazione:', outcome);
      deferredPrompt = null;
    }
  });
  
  // Aggiungi pulsante alla topbar
  const controls = document.querySelector('.controls-secondary');
  if (controls) {
    controls.appendChild(installBtn);
  }
});

// Gestione installazione completata
window.addEventListener('appinstalled', () => {
  console.log('‚úÖ PWA installata con successo');
  deferredPrompt = null;
});

// Inizializzazione icone personalizzate
document.addEventListener('DOMContentLoaded', () => {
  // Aggiorna tutte le icone del menu
  if (typeof updateMenuIcons === 'function') {
    updateMenuIcons();
  }
  
  // Aggiorna icone dinamiche se necessario
  setTimeout(() => {
    // Forza aggiornamento icone dopo caricamento completo
    if (typeof updateMenuIcons === 'function') {
      updateMenuIcons();
    }
  }, 1000);
});
</script>

</body>
</html>
